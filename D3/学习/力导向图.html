<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å­¦ä¹ </title>
  </head>
  <style type="text/css">
    * {
    }
  </style>
  <!-- D3 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <body>
    <div class="d3Chart"></div>
  </body>
  <script type="text/javascript">
    // èŠ‚ç‚¹é›†
    // radius èŠ‚ç‚¹åŠå¾„
    const nodes = [
      { name: 'é‡åº†å¸‚', radius: 4 },
      { name: 'åŒ—ç¢šåŒº', radius: 3 },
      { name: 'æ¸åŒ—åŒº', radius: 3 },
      { name: 'æ±ŸåŒ—åŒº', radius: 3 },
      { name: 'å·´å—åŒº', radius: 3 },
      { name: 'æ²™åªååŒº', radius: 3 },
      { name: 'å¤§æ¸¡å£', radius: 3 },
      { name: 'ä¸‡å·žåŒº', radius: 3 },
      { name: 'å¤©åºœé•‡', radius: 2 },
      { name: 'æ°´åœŸé•‡', radius: 2 },
      { name: 'è”¡å®¶é•‡', radius: 2 },
      { name: 'åœŸåœºé•‡', radius: 2 },
      { name: 'ä¸¤æ±Ÿåå±…', radius: 1 },
      { name: 'ä¸ŠåŸŽä¸­å¤®', radius: 1 },
      { name: 'ç¯å¡”', radius: 1 }
    ]
    // è¾¹é›†
    // value æŽ§åˆ¶çº¿çš„é•¿çŸ­
    const edges = [
      { source: 0, target: 1, value: 2 },
      { source: 0, target: 2, value: 2 },
      { source: 0, target: 3, value: 2 },
      { source: 0, target: 4, value: 2 },
      { source: 0, target: 5, value: 2 },
      { source: 0, target: 6, value: 2 },
      { source: 0, target: 7, value: 2 },
      { source: 2, target: 8, value: 1.5 },
      { source: 2, target: 9, value: 1.5 },
      { source: 2, target: 10, value: 1.5 },
      { source: 2, target: 11, value: 1.5 },
      { source: 11, target: 12, value: 1 },
      { source: 11, target: 13, value: 1 },
      { source: 11, target: 14, value: 1 }
    ]

    // ç”»å¸ƒ
    const width = 1000
    const height = 1000
    const svg = d3
      .select('.d3Chart')
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .style('background-color', '#1a3055')
    // å›¾
    const chart = svg.append('g')

    // åˆ›å»ºé¢œè‰²æ¯”ä¾‹å°º
    const colorScale = d3.scaleOrdinal(d3.quantize(d3.interpolateRainbow, nodes.length + 1))

    const force = d3
      .forceSimulation()
      // .velocityDecay(0.1) //é€Ÿåº¦è¡°å‡
      // .alphaDecay(0) //alphaè¡°å˜, 0è¡¨ç¤ºä¸è¡°å‡
      .force('link', d3.forceLink())
      .force('charge', d3.forceManyBody())
      .force('center', d3.forceCenter(width / 2, height / 2))

    force.nodes(nodes).on('tick', ticked)

    force
      .force('link')
      .links(edges)
      .distance(function (d) {
        //æ¯ä¸€è¾¹çš„é•¿åº¦
        return d.value * 150
      })

    //åœ¨æµè§ˆå™¨çš„æŽ§åˆ¶å°è¾“å‡º
    console.log(nodes)
    console.log(edges)

    const links = chart
      .append('g')
      .selectAll('line')
      .data(edges)
      .enter()
      .append('line')
      .attr('stroke', '#ccc')
      .attr('stroke-width', 1)

    const linksText = chart
      .append('g')
      .selectAll('text')
      .data(edges)
      .enter()
      .append('text')
      .text(function (d) {
        return d.value
      })
      .attr('fill', '#ccc')

    // ç»˜åˆ¶èŠ‚ç‚¹
    const nodesChart = chart.append('g')
    const gs = nodesChart
      .selectAll()
      .data(nodes)
      .enter()
      .append('g')
      .attr('transform', function (d, i) {
        var cirX = d.x
        var cirY = d.y
        return 'translate(' + cirX + ',' + cirY + ')'
      })
      .call(d3.drag().on('start', started).on('drag', dragged).on('end', ended))

    gs.append('circle')
      .attr('r', function (d, i) {
        // åŠå¾„
        return d.radius * 10
      })
      .attr('fill', function (d, i) {
        return colorScale(d.name)
      })

    gs.append('text')
      .attr('x', -20)
      .attr('y', -5)
      .attr('dy', 10)
      .attr('font-size', 12)
      .text(function (d) {
        return d.name
      })
      .attr('fill', '#ccc')
      .attr('pointer-events', 'none')
      .style('user-select', 'none')

    function ticked() {
      links
        .attr('x1', function (d) {
          return d.source.x
        })
        .attr('y1', function (d) {
          return d.source.y
        })
        .attr('x2', function (d) {
          return d.target.x
        })
        .attr('y2', function (d) {
          return d.target.y
        })

      linksText
        .attr('x', function (d) {
          return (d.source.x + d.target.x) / 2
        })
        .attr('y', function (d) {
          return (d.source.y + d.target.y) / 2
        })

      gs.attr('transform', function (d) {
        return 'translate(' + d.x + ',' + d.y + ')'
      })
    }

    function started(d) {
      // if (!d3.event.active) {
      force.alphaTarget(1).restart() //è®¾ç½®è¡°å‡ç³»æ•°ï¼Œå¯¹èŠ‚ç‚¹ä½ç½®ç§»åŠ¨è¿‡ç¨‹çš„æ¨¡æ‹Ÿï¼Œæ•°å€¼è¶Šé«˜ç§»åŠ¨è¶Šå¿«ï¼Œæ•°å€¼èŒƒå›´[0ï¼Œ1]
      // }
      d.fx = d.x
      d.fy = d.y
    }
    function dragged(d) {
      console.log('ðŸš€ ~ file: åŠ›å¯¼å‘å›¾.html ~ line 187 ~ dragged ~ d', d, d.sourceEvent.clientX)
      d.fx = d.sourceEvent.clientX
      d.fy = d.sourceEvent.clientY
    }
    function ended(d) {
      // if (!d3.event.active) {
      // force.alphaTarget(0)
      // }
      d.fx = null
      d.fy = null
    }

    // const force = d3
    //   .forceSimulation()
    //   .velocityDecay(0.8) //é€Ÿåº¦è¡°å‡
    //   .alphaDecay(0) //alphaè¡°å˜, 0è¡¨ç¤ºä¸è¡°å‡
    //   .force('charge', d3.forceManyBody()) //èŠ‚ç‚¹ç›¸äº’ä½œç”¨åŠ›ï¼Œé»˜è®¤ä¸ºæ–¥åŠ›-30
    //   .force('collision', d3.forceCollide(12 + 0.2).strength(0.1)) //ç¢°æ’ž
    //   .force('center', d3.forceCenter(width / 2, height / 2))

    // force.nodes(nodes) //ç»‘å®šèŠ‚ç‚¹

    // force.force('link', d3.forceLink(edges).strength(1).distance(20)) //ç»‘å®šèŠ‚ç‚¹é—´é“¾æŽ¥

    // const points = chart.selectAll('circle').data(nodes)

    // points
    //   .enter()
    //   .append('circle')
    //   .attr('r', function (d, i) {
    //     // åŠå¾„
    //     return d.radius * 10
    //   })
    //   .attr('fill', (d) => colorScale(d.name))

    // const drag = d3
    //   .drag()
    //   .on('start', (d) => {
    //     d.fx = d.x
    //     d.fy = d.y
    //   })
    //   .on('drag', (d) => {
    //     d.fx = d3.event.x
    //     d.fy = d3.event.y
    //   })
    //   .on('end', (d) => {
    //     d.fx = null
    //     d.fy = null
    //   })

    // chart.selectAll('circle').call(drag)

    // force.on('tick', function () {
    //   // chart
    //   //   .body()
    //   //   .selectAll('line')
    //   //   .attr('x1', (d) => d.source.x)
    //   //   .attr('y1', (d) => d.source.y)
    //   //   .attr('x2', (d) => d.target.x)
    //   //   .attr('y2', (d) => d.target.y)

    //   chart
    //     .selectAll('circle')
    //     .attr('cx', (d) => d.x)
    //     .attr('cy', (d) => d.y)
    // })
  </script>
</html>
