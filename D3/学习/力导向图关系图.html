<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>d3å…³ç³»å›¾è°±</title>
  </head>

  <body>
    <svg
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      id="svgId"
      height="1000"
      width="100%"
    ></svg>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
      const data = {
        nodes: [
          {
            currency: 'ä¸‡å…ƒ',
            id: '130790264',
            img: '',
            name: 'å…†åæŠ•èµ„æœ‰é™å…¬å¸',
            organ: false,
            reg_amount: 0,
            type: 'company'
          },
          {
            currency: 'ä¸‡å…ƒ',
            id: '115804450',
            img: '',
            name: 'åŒ—äº¬å…†åé£Ÿå“æœ‰é™å…¬å¸ä¸Šæµ·é”€å”®åˆ†éƒ¨',
            organ: false,
            reg_amount: 0,
            type: 'company'
          },
          {
            ex_com_id: 67,
            id: '126',
            img: '',
            name: 'ç¿ç¥–æ˜',
            type: 'man'
          },
          {
            ex_com_id: '115804450',
            id: '7065171',
            name: 'æ¨æ•¬ç¥–',
            type: 'man'
          },
          {
            ex_com_id: 67932906,
            id: '8032034',
            name: 'é™ˆå®¶å',
            type: 'man'
          },
          {
            ex_com_id: 67932906,
            id: '69542',
            img: '',
            name: 'æ—æ°',
            type: 'man'
          },
          {
            ex_com_id: 67932906,
            id: '630248',
            img: '',
            name: 'é™ˆé’Ÿå³°',
            type: 'man'
          },
          {
            currency: 'ä¸‡ç¾å…ƒ',
            id: '67932906',
            img: '',
            name: 'ä¸¹é˜³é’±éš†é‡‘å±ææ–™æœ‰é™å…¬å¸',
            organ: false,
            reg_amount: 2990,
            type: 'company'
          },
          {
            ex_com_id: 67932906,
            id: '17302430',
            img: '',
            name: 'é™ˆèº«ç§€',
            type: 'man'
          },
          {
            ex_com_id: 67932906,
            id: '17302431',
            img: '',
            name: 'é™ˆå…´èº',
            type: 'man'
          },
          {
            currency: 'ä¸‡ç¾å…ƒ',
            id: '67',
            img: '',
            name: 'åŒ—äº¬å…†åé£Ÿå“æœ‰é™å…¬å¸',
            organ: false,
            reg_amount: 12,
            type: 'company'
          }
        ],
        links: [
          {
            src: 130790264,
            dst: 67932906,
            type: 'æŠ•èµ„',
            with: 'company'
          },
          {
            src: 126,
            dst: 67,
            type: 'æ³•å®šä»£è¡¨äºº',
            with: 'man'
          },
          {
            src: 126,
            dst: 130790264,
            type: 'æŠ•èµ„',
            with: 'man'
          },
          {
            src: 7065171,
            dst: 115804450,
            type: 'æ³•å®šä»£è¡¨äºº',
            with: 'man'
          },
          {
            src: 7065171,
            dst: 130790264,
            type: 'æ³•å®šä»£è¡¨äºº',
            with: 'man'
          },
          {
            src: 8032034,
            dst: 67932906,
            type: 'è‘£äº‹',
            with: 'man'
          },
          {
            src: 17302430,
            dst: 67932906,
            type: 'æ³•å®šä»£è¡¨äºº',
            with: 'man'
          },
          {
            src: 17302431,
            dst: 67932906,
            type: 'å‰¯è‘£äº‹é•¿',
            with: 'man'
          },
          {
            src: 69542,
            dst: 67932906,
            type: 'æŠ•èµ„',
            with: 'man'
          },
          {
            src: 630248,
            dst: 67932906,
            type: 'ç›‘äº‹',
            with: 'man'
          }
        ]
      }

      const { nodes, links } = data
      const width = document.documentElement.clientWidth
      const height = document.documentElement.clientHeight
      formatLink(links, nodes)
      formatNode(nodes)

      const simulation = d3
        .forceSimulation(nodes)
        .force('link', d3.forceLink(links).distance(200))
        .force('charge', d3.forceManyBody().strength(-200).distanceMax(100))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .on('tick', tick)

      // åˆ›å»ºä¸€ä¸ªæ ¹å®¹å™¨ï¼Œç”¨äºå­˜æ”¾è¦ç”»çš„å›¾å½¢
      const container = d3.select('svg').append('g').attr('class', 'container')

      // ç»˜åˆ¶ç®­å¤´
      drawMarker()
      // ç»˜åˆ¶è¿æ¥çº¿
      drawLinkPath(container, links)
      // ç»˜åˆ¶å…³ç³»æ–‡æœ¬
      drawRelationText(container, links)

      // åœ†åœˆå’Œæ–‡å­—çš„å¤–å±‚gï¼Œå¯ä»¥åœ¨è¿™ä¸ªä¸Šé¢æ·»åŠ ç‚¹å‡»ã€hoveräº‹ä»¶
      let nodeSelection = container
        .append('g')
        .attr('class', 'nodegroup')
        .selectAll('.node')
        .data(nodes)
        .enter()
        .append('g')
        .attr('id', (d) => {
          return d.idx
        })

      // éå†ç»˜åˆ¶åœ†åœˆå’Œåœ†åœˆä¸Šçš„æ–‡æœ¬
      nodeSelection.each((d) => {
        drawCircle(d.idx)
        drawText(d.idx)
      })

      // ===== ç»˜å›¾ =====
      function drawMarker() {
        d3.select('svg')
          .append('svg:defs')
          .append('svg:marker')
          .attr('id', 'blueMarker')
          .attr('viewBox', '0 -5 10 10')
          .attr('refX', 70)
          .attr('refY', 0)
          .attr('markerUnits', 'userSpaceOnUse')
          .attr('markerWidth', 6)
          .attr('markerHeight', 6)
          .attr('orient', 'auto')
          .append('svg:path')
          .attr('d', 'M0,-5L10,0L0,5')
          .attr('fill', '#4099ea')
        d3.select('svg')
          .select('defs')
          .append('svg:marker')
          .attr('id', 'redMarker')
          .attr('viewBox', '0 -5 10 10')
          .attr('refX', 70)
          .attr('refY', 0)
          .attr('markerUnits', 'userSpaceOnUse')
          .attr('markerWidth', 6)
          .attr('markerHeight', 6)
          .attr('orient', 'auto')
          .append('svg:path')
          .attr('d', 'M0,-5L10,0L0,5')
          .attr('fill', '#fd6568')
      }

      function drawCircle(id) {
        const circleG = d3.select(`#${id}`).attr('class', 'circle-g')
        circleG
          .append('circle')
          .attr('class', 'real-circle')
          .attr('fill', (d) => {
            // æŸä¸ªä¼ä¸šè¯¦æƒ…é¡µç‚¹å‡»è¿›æ¥çš„ï¼Œç»™ä¸ªè¿™ä¸ªä¼ä¸šç‰¹æ®Šæ ·å¼
            if (d.isSelf) {
              return '#fe9d3b'
            }
            if (d.type === 'man') {
              return '#fe5557'
            }
            return '#52a3eb'
          })
          .attr('stroke', function (d) {
            if (d.isSelf) {
              return '#ec8a2f'
            } else if (d.type === 'company') {
              return '#0082e5'
            }
            return 'none'
          })
          // è®¾ç½®åœ†åœˆåŠå¾„
          .attr('r', (d) => {
            if (d.type === 'man') {
              return 23
            }
            return 35
          })
      }

      function drawText(id) {
        d3.select(`#${id}`)
          .insert('text')
          .attr('class', 'circle-text')
          .attr('dy', '.35em')
          .attr('text-anchor', 'middle')
          .attr('font-size', 12)
          .style('fill', function (node) {
            return '#fff'
          })
          .attr('y', (d) => {
            return d.x
          })
          .attr('x', function (d) {
            let re_en = /[a-zA-Z]+/g
            //å¦‚æœæ˜¯å…¨è‹±æ–‡ï¼Œä¸æ¢è¡Œ
            if (d.name.match(re_en)) {
              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', 2)
                .text(function () {
                  return d.name
                })
            }
            //å¦‚æœå°äºå››ä¸ªå­—ç¬¦ï¼Œä¸æ¢è¡Œ
            else if (d.name.length <= 4) {
              d3.select(this)
                .append('tspan')
                .attr('x', -2)
                .attr('y', 2)
                .text(function () {
                  return d.name
                })
            } else if (d.name.length > 4 && d.name.length <= 8) {
              //å¤§äº4  è¿™ä¸¤è¡Œ
              let top = d.name.substring(0, 4)
              let bot = d.name.substring(4, d.name.length)

              d3.select(this).text(function () {
                return ''
              })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', -7)
                .text(function () {
                  return top
                })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', 10)
                .text(function () {
                  return bot
                })
            }
            // æ–‡å­—é•¿åº¦å¤§äº8 æŠ˜ä¸‰è¡Œ
            else if (d.name.length > 8 && d.name.length <= 12) {
              let top = d.name.substring(0, 4)
              let bot = d.name.substring(4, 8)
              let bot1 = d.name.substring(8, d.name.length)

              d3.select(this).text(function () {
                return ''
              })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', -15)
                .text(function () {
                  return top
                })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', 2)
                .text(function () {
                  return bot
                })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', 16)
                .text(function () {
                  return bot1
                })
            }
            //æ–‡å­—é•¿åº¦å¤§äº12 æŠ˜å››è¡Œ
            else if (d.name.length > 12 && d.name.length <= 16) {
              let top = d.name.substring(0, 4)
              let bot = d.name.substring(4, 8)
              let bot1 = d.name.substring(8, 12)
              let bot2 = d.name.substring(12, d.name.length)

              d3.select(this).text(function () {
                return ''
              })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', -20)
                .text(function () {
                  return top
                })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', -3)
                .text(function () {
                  return bot
                })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', 10)
                .text(function () {
                  return bot1
                })
              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', 23)
                .text(function () {
                  return bot2
                })
            } else if (d.name.length > 16) {
              //æ–‡å­—é•¿åº¦å¤§äº16  æ–¹æ¡ˆ
              let top = d.name.substring(0, 4)
              let bot = d.name.substring(4, 8)
              let bot1 = d.name.substring(8, 12)
              let bot2 = d.name.substring(12, 14)

              bot2 += '...'
              d3.select(this).text(function () {
                return ''
              })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', -22)
                .text(function () {
                  return top
                })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', -7)
                .text(function () {
                  return bot
                })

              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', 10)
                .text(function () {
                  return bot1
                })
              d3.select(this)
                .append('tspan')
                .attr('x', 0)
                .attr('y', 25)
                .text(function () {
                  return bot2
                })
            }
          })
      }

      function drawLinkPath(container, links) {
        // æ·»åŠ è¿æ¥è·¯å¾„path
        container
          .append('g')
          .attr('class', 'line-path')
          .selectAll('.path')
          .data(links)
          .enter()
          .append('path')
          .attr('class', 'path')
          .attr('fill', 'none')
          .attr('stroke-width', 1)
          .attr('stroke', '#D8D8D8')
          .attr('marker-end', function (d) {
            let id = 'blueMarker'
            if (d.type === 'æŠ•èµ„') {
              id = 'redMarker'
            }
            return `url(#${id})`
          })
          .attr('cursor', 'pointer')
      }

      function drawRelationText(container, links) {
        //è¾¹ä¸Šçš„æ–‡å­—ï¼ˆäººç‰©ä¹‹é—´çš„å…³ç³»ï¼‰
        let edges_text = container
          .append('g')
          .attr('class', 'relation-text')
          .selectAll('.linetext')
          .data(links)
          .enter()
          .append('svg:g')
          .attr('class', 'linetext')
          .attr('fill-opacity', 1)

        edges_text
          .append('svg:text')
          .attr('font-size', 10)
          .attr('fill', '#8e8e8e')
          .attr('y', '.31em')
          .attr('text-anchor', 'middle')
          .text(function (d) {
            return d.type
          })

        edges_text
          .insert('rect', 'text')
          .attr('width', function (d, i, e) {
            const { width } = e[i].parentNode.getBoundingClientRect()
            return width
          })
          .attr('height', function (d) {
            return 14
          })
          .attr('y', '-.5em')
          .attr('x', function (d, i, e) {
            const { width } = e[i].nextSibling.getBoundingClientRect()
            return -width / 2
          })
          .attr('fill', 'rgba(255,255,255,.5)')
      }

      function formatNode(nodes) {
        const name = ''
        nodes.forEach((node) => {
          if (name === node.name) {
            node.isSelf = true
          }
          node.idx = 'zf' + uuid()
        })
      }
      // æ ¼å¼åŒ–è¿æ¥å…³ç³»æ•°æ®
      function formatLink(links, nodes) {
        links.forEach((link, i) => {
          link.index = i
          const src = nodes.find((node) => node.id == link.src)
          const dst = nodes.find((node) => node.id == link.dst)
          link['source'] = src
          link['target'] = dst
        })
      }
      function uuid() {
        return Math.random().toString(34).replaceAll(/\,|\./g, '')
      }

      // ===== æ›´æ–° =====
      function tick() {
        updateLinkLine()
        updateCircleAndText()
        updateLinkRelationText()
      }
      function updateCircleAndText() {
        d3.selectAll('circle')
          .attr('cx', (d) => {
            return d.x
          })
          .attr('cy', (d) => d.y)
        d3.selectAll('.circle-text').attr('transform', (d) => {
          return `translate(${d.x},${d.y})`
        })
      }
      function updateLinkLine() {
        const edges_line = d3.selectAll('.path')
        edges_line.attr('d', function (d) {
          return 'M' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y
        })
      }
      function updateLinkRelationText() {
        const svg = d3.select('svg')
        let edges_text = svg.selectAll('.linetext')

        //æ›´æ–°è¿æ¥çº¿ä¸Šæ–‡å­—çš„ä½ç½®
        edges_text.attr('transform', function (d) {
          let translateX = (d.source.x + d.target.x) / 2
          let translateY = (d.source.y + d.target.y) / 2
          return `translate(${translateX},${translateY}) rotate(0)`
        })
      }

      // ===== æ‹–æ‹½ =====
      const dragFunc = d3.drag().on('start', dragStarted).on('drag', dragged).on('end', dragend)

      dragFunc(nodeSelection)
      function dragStarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.01).restart()
        console.log('ğŸš€ ~ file: åŠ›å¯¼å‘å›¾å…³ç³»å›¾.html ~ line 580 ~ dragStarted ~ d3.event', d3.event, d)
        d.fx = d.x
        d.fy = d.y
      }
      function dragged(d) {
        d.fx = d3.event.x
        d.fy = d3.event.y
      }
      function dragend(d) {
        if (!d3.event.active) simulation.alphaTarget(0)
        d.fx = null
        d.fy = null
      }

      // ===== ç¼©æ”¾ =====
      initZoom()
      function initZoom() {
        const zoom = d3
          .zoom()
          .scaleExtent([0.2, 5])
          .on('zoom', () => {
            let transform = d3.event.transform
            return container.attr('transform', `translate(${transform.x},${transform.y})scale(${transform.k})`)
          })

        //åŠ¨ç”»æŒç»­æ—¶é—´
        container.transition().duration(300).call(zoom.transform, d3.zoomIdentity)
        d3.select('svg')
          .call(zoom)
          // å–æ¶ˆé»˜è®¤çš„åŒå‡»æ”¾å¤§äº‹ä»¶
          .on('dblclick.zoom', null)
      }
    </script>
  </body>
</html>
