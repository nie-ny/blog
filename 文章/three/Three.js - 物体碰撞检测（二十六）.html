<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>å­¦ä¹ </title>
  </head>
  <body>
    <canvas id="c2d" class="c2d" width="1000" height="500"></canvas>
    <script type="module">
      import * as THREE from './file/three.js-dev/build/three.module.js'

      const canvas = document.querySelector('#c2d')
      // æ¸²æŸ“å™¨
      const renderer = new THREE.WebGLRenderer({ canvas })

      const fov = 40 // è§†é‡èŒƒå›´
      const aspect = 2 // ç›¸æœºé»˜è®¤å€¼ ç”»å¸ƒçš„å®½é«˜æ¯”
      const near = 0.1 // è¿‘å¹³é¢
      const far = 10000 // è¿œå¹³é¢
      // é€è§†æŠ•å½±ç›¸æœº
      const camera = new THREE.PerspectiveCamera(fov, aspect, near, far)
      camera.position.set(0, 6, 5)
      camera.lookAt(0, 0, 0)

      // åœºæ™¯
      const scene = new THREE.Scene()
      {
        // ç¯å…‰
        const color = 0xffffff
        const intensity = 1
        const light = new THREE.DirectionalLight(color, intensity)
        light.position.set(-1, 10, 4)
        scene.add(light)
      }

      // ç«‹æ–¹ä½“
      const boxWidth = 1
      const boxHeight = 1
      const boxDepth = 1
      const geometry = new THREE.BoxGeometry(boxWidth, boxHeight, boxDepth)

      const material = new THREE.MeshPhongMaterial({
        color: 0x6688aa
      })
      const cube = new THREE.Mesh(geometry, material)
      cube.position.x = -1
      scene.add(cube)

      const material2 = new THREE.MeshPhongMaterial({
        color: 0x6688aa
      })
      const cube2 = new THREE.Mesh(geometry, material2)
      cube2.position.x = 1
      scene.add(cube2)

      function onIntersect() {
        // å£°æ˜ä¸€ä¸ªå˜é‡ç”¨æ¥è¡¨ç¤ºæ˜¯å¦ç¢°æ’
        let bool = false

        // .position å¯¹è±¡å±€éƒ¨ä½ç½®
        // .clone() å¤åˆ¶ä¸€ä¸ªæ–°çš„ä¸‰ç»´å‘é‡
        // ç½‘æ ¼ä¸­å¿ƒ ä¸–ç•Œåæ ‡
        const centerCoord = cube.position.clone()
        console.log('ğŸš€ ~ file: Three.js - ç‰©ä½“ç¢°æ’æ£€æµ‹ï¼ˆäºŒåå…­ï¼‰.html ~ line 64 ~ onIntersect ~ cube', cube)
        // è·å–ç½‘æ ¼ä¸­ å‡ ä½•å¯¹è±¡çš„é¡¶ç‚¹å¯¹è±¡
        const position = cube.geometry.attributes.position
        // é¡¶ç‚¹ä¸‰ç»´å‘é‡
        const vertices = []
        // .count çŸ¢é‡ä¸ªæ•°
        for (let i = 0; i < position.count; i++) {
          // .getX() è·å–ç»™å®šç´¢å¼•çš„çŸ¢é‡çš„ç¬¬ä¸€ç»´å…ƒç´ 
          vertices.push(new THREE.Vector3(position.getX(i), position.getY(i), position.getZ(i)))
        }

        for (let i = 0; i < vertices.length; i++) {
          // .matrixWorld ç‰©ä½“çš„ä¸–ç•Œåæ ‡å˜æ¢ -- ç‰©ä½“æ—‹è½¬ã€ä½ç§» çš„å››ç»´çŸ©é˜µ
          // .applyMatrix4() å°†è¯¥å‘é‡ä¹˜ä»¥å››é˜¶çŸ©é˜µ
          // è·å–ä¸–ç•Œåæ ‡ä¸‹ ç½‘æ ¼å˜æ¢åçš„åæ ‡
          let vertexWorldCoord = vertices[i].clone().applyMatrix4(cube.matrixWorld)

          // .sub(x) ä»è¯¥å‘é‡å‡å»xå‘é‡
          // è·å¾—ç”±ä¸­å¿ƒæŒ‡å‘é¡¶ç‚¹çš„å‘é‡
          var dir = vertexWorldCoord.clone().sub(centerCoord)

          // .normalize() å°†è¯¥å‘é‡è½¬æ¢ä¸ºå•ä½å‘é‡
          // å‘å°„å…‰çº¿ centerCoord ä¸ºæŠ•å°„çš„åŸç‚¹å‘é‡  dir å‘å°„çº¿æä¾›æ–¹å‘çš„æ–¹å‘å‘é‡
          let raycaster = new THREE.Raycaster(centerCoord, dir.clone().normalize())

          // æ”¾å…¥è¦æ£€æµ‹çš„ ç‰©ä½“cube2ï¼Œè¿”å›ç›¸äº¤ç‰©ä½“
          let intersects = raycaster.intersectObjects([cube2], true)

          if (intersects.length > 0) {
            // intersects[0].distanceï¼šå°„çº¿èµ·ç‚¹ä¸äº¤å‰ç‚¹ä¹‹é—´çš„è·ç¦»(äº¤å‰ç‚¹ï¼šå°„çº¿å’Œæ¨¡å‹è¡¨é¢äº¤å‰ç‚¹åæ ‡)
            // dir.length()ï¼šçƒä½“é¡¶ç‚¹å’Œçƒä½“å‡ ä½•ä¸­å¿ƒæ„æˆå‘é‡çš„é•¿åº¦
            // intersects[0].distanceå°äºdir.length() è¡¨ç¤ºç‰©ä½“ç›¸äº¤
            if (intersects[0].distance < vertexWorldCoord.length()) {
              bool = true
            }
          }
        }

        return bool
      }

      document.addEventListener(
        'keydown',
        (e) => {
          var ev = e || window.event
          switch (ev.keyCode) {
            case 87:
              cube.position.z -= 0.05
              break
            case 83:
              cube.position.z += 0.05
              break
            case 65:
              cube.position.x -= 0.05
              break
            case 68:
              cube.position.x += 0.05
              break
            default:
              break
          }
          if (onIntersect()) {
            cube.material.color.set('yellow')
          } else {
            cube.material.color.set(0x6688aa)
          }
        },
        false
      )

      // æ¸²æŸ“
      function render() {
        renderer.render(scene, camera)
        requestAnimationFrame(render)
      }
      requestAnimationFrame(render)
    </script>
  </body>
</html>
