<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å­¦ä¹ </title>
  </head>
  <style type="text/css"></style>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <body>
    <div class="d3Chart"></div>
  </body>
  <script type="text/javascript">
    //
    const margin = { top: 80, right: 65, bottom: 5, left: 20 }
    const width = 1200
    const height = 700

    const svg = d3.select('.d3Chart').append('svg').attr('width', width).attr('height', height)
    const chart = svg.append('g').attr('transform', `translate(${margin.top}, ${margin.left})`)

    // å±•ç¤ºæ¡æ•°
    const top_n = 20
    // é—´è·
    const barPadding = (height - margin.top - margin.bottom) / (top_n * 5)
    // æŽ’åå¼€å§‹å¹´ä»½
    let year = 2000
    // æ‰§è¡Œé—´éš”
    const tickDuration = 100

    // æ¯”ä¾‹å°ºå‡½æ•°
    const xScale = d3
      .scaleLinear()
      .range([margin.left, width - margin.right])
      .nice()
    const yScale = d3
      .scaleLinear()
      .domain([top_n, 0])
      .range([height - margin.bottom, margin.top])
    // æŽ’è¡Œåªéœ€è¦ ç»˜åˆ¶ Xè½´
    // ç»˜åˆ¶åæ ‡è½´å‡½æ•°
    const xAxis = d3
      .axisTop(xScale)
      .ticks(width > 500 ? 5 : 2)
      .tickSize(-(height - margin.top - margin.bottom))

    // d3.csv() èŽ·å–é€—å·åˆ†éš”å€¼ï¼ˆCSVï¼‰æ–‡ä»¶
    d3.csv('./file/brand_values.csv').then((data) => {
      // æ•°æ®æ ¼å¼è½¬æ¢
      data.forEach((d) => {
        d.lastValue = Number(d.lastValue)
        d.value = isNaN(d.value) ? 0 : Number(d.value)
        d.year = Number(d.year)
        d.rank = Number(d.rank)
        d.color = d3.hsl(Math.random() * 360, 1, 0.75, 0.8)
      })

      // æ ¹æ®å¼€å§‹å¹´ä»½ èŽ·å–å½“å¹´æ•°æ® å¹¶è¿›è¡ŒæŽ’åº æˆªå–ä¸ºè®¾ç½®çš„æ¡æ•° å¹¶å¯¹æ•°æ®è®¾ç½®æŽ’å
      let yearSlice = data
        .filter((d) => d.year == year && !isNaN(d.value))
        .sort((a, b) => b.value - a.value)
        .slice(0, top_n)
      yearSlice.forEach((d, i) => (d.rank = i))
      console.log('ðŸš€ ~ file: å­¦ä¹ D3.jsï¼ˆäºŒåå…­ï¼‰æŽ’åæŸ±çŠ¶å›¾.html ~ line 66 ~ d3.csv ~ yearSlice', yearSlice)

      render_init(yearSlice)

      let ticker = d3.interval((e) => {
        // ~~ å‘ä¸Šå–æ•´
        svg.select('.yearText').html(~~year)
        // ä¿ç•™ä¸€ä½å°æ•°
        year = d3.format('.1f')(+year + 0.1)
        // ç»“æŸå¾ªçŽ¯
        if (year === '2018.0') {
          ticker.stop()
        }

        // é‡æ–°åˆ‡åˆ†æ•°æ®
        yearSlice = data
          .filter((d) => d.year == year && !isNaN(d.value))
          .sort((a, b) => b.value - a.value)
          .slice(0, top_n)
        yearSlice.forEach((d, i) => {
          d.rank = i
        })

        // ä¿®æ”¹æ¯”ä¾‹å°º
        xScale.domain([0, d3.max(yearSlice, (d) => d.value) + 10000])
        // xè½´é‡æ–°ç»˜åˆ¶ æ·»åŠ åŠ¨ç”»
        svg.select('.xAxis').transition().duration(tickDuration).ease(d3.easeLinear).call(xAxis)

        // ç»‘å®šæ•°æ® é€šè¿‡æ ‡è¯†ç¬¦åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        const bars = svg.selectAll('.bar').data(yearSlice, (d) => d.name)
        // ä¸å­˜åœ¨çš„ æŸ±çŠ¶è¿›è¡Œåˆ›å»º
        bars
          .enter()
          .append('rect')
          .attr('class', 'bar')
          .attr('x', xScale(0) + margin.left + 1)
          .attr('width', (d) => xScale(d.value) - xScale(0))
          .attr('y', (d) => yScale(top_n + 1) + 5)
          .attr('height', yScale(1) - yScale(0) - barPadding)
          .attr('fill', (d) => d.color)
        // å¯¹çŽ°å­˜åœ¨çš„æ‰€æœ‰ èŠ‚ç‚¹ æ·»åŠ åŠ¨ç”»
        bars
          .transition()
          .duration(tickDuration)
          .ease(d3.easeLinear)
          .attr('width', (d) => xScale(d.value) - xScale(0))
          .attr('y', (d) => yScale(d.rank) + 5)
        // åˆ é™¤æ•°æ®ä¸­ä»¥ä¸å­˜åœ¨çš„èŠ‚ç‚¹ æ·»åŠ ç¦»å¼€åŠ¨ç”»
        bars
          .exit()
          .transition()
          .duration(tickDuration)
          .ease(d3.easeLinear)
          .attr('y', (d) => yScale(top_n + 1) + 5)
          .attr('width', 0)
          .remove()

        const labels = svg.selectAll('.label').data(yearSlice, (d) => d.name)
        labels
          .enter()
          .append('text')
          .attr('class', 'label')
          .attr('x', (d) => xScale(d.value))
          .attr('y', (d) => yScale(top_n + 1) + 8)
          .attr('text-anchor', 'end')
          .text((d) => d.name)

        labels
          .transition()
          .duration(tickDuration)
          .ease(d3.easeLinear)
          .attr('x', (d) => xScale(d.value))
          .attr('y', (d) => yScale(d.rank) + (yScale(1) - yScale(0)) / 2 + 8)

        labels
          .exit()
          .transition()
          .duration(tickDuration)
          .ease(d3.easeLinear)
          .attr('y', (d) => yScale(top_n + 1) + 20)
          .remove()

        const valueLabels = svg.selectAll('.valueLabel').data(yearSlice, (d) => d.name)
        valueLabels
          .enter()
          .append('text')
          .attr('class', 'valueLabel')
          .attr('x', (d) => xScale(d.value) + 30)
          .attr('y', (d) => yScale(top_n) + 20)
          .text((d) => d3.format(',.0f')(d.lastValue))

        valueLabels
          .transition()
          .duration(tickDuration)
          .ease(d3.easeLinear)
          .attr('x', (d) => xScale(d.value) + 30)
          .attr('y', (d) => yScale(d.rank) + (yScale(1) - yScale(0)) / 2 + 8)
          .tween('textTween', function (d) {
            //åšå‡ºåœ¨ä¸¤ä¸ªvalueé—´è·³åŠ¨çš„æ•ˆæžœ
            let i = d3.interpolateRound(d.lastValue, d.value)
            return function (t) {
              this.textContent = d3.format(',')(i(t))
            }
          })

        valueLabels
          .exit()
          .transition()
          .duration(tickDuration)
          .ease(d3.easeLinear)
          .attr('x', (d) => xScale(d.value) + 30)
          .attr('y', (d) => yScale(top_n + 1) + 20)
          .remove()

        //
      }, 30)
    })

    /**
     * åˆå§‹åŒ–æŸ±çŠ¶å›¾
     */
    function render_init(yearSlice) {
      // ç»˜åˆ¶æ ‡é¢˜
      chart
        .append('text')
        .attr('class', 'title')
        .attr('y', 30)
        .attr('x', width / 2)
        .attr('style', 'font-size: 2em;font-weight: 500;')
        .text('æŽ’åæŸ±çŠ¶å›¾')

      xScale.domain([0, d3.max(yearSlice, (d) => d.value) + 10000])
      svg.append('g').attr('class', 'xAxis').call(xAxis).attr('transform', `translate(${margin.left},${margin.top})`)

      // æŸ±çŠ¶ç»˜åˆ¶
      svg
        .selectAll('rect.bar')
        .data(yearSlice, (d) => d.name)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', xScale(0) + margin.left + 1)
        .attr('width', (d) => xScale(d.value) - xScale(0))
        .attr('y', (d) => yScale(d.rank) + 5)
        .attr('height', yScale(1) - yScale(0) - barPadding)
        .attr('fill', (d) => d.color)

      // å“ç‰Œåç»˜åˆ¶
      svg
        .selectAll('text.label')
        .data(yearSlice, (d) => name)
        .enter()
        .append('text')
        .attr('class', 'label')
        .attr('style', 'font-weight: 500;')
        .attr('x', (d) => xScale(d.value))
        .attr('y', (d) => yScale(d.rank) + (yScale(1) - yScale(0)) / 2 + 8)
        .attr('text-anchor', 'end')
        .text((d) => d.name)

      // æ•°å€¼ç»˜åˆ¶
      svg
        .selectAll('text.valueLabel')
        .data(yearSlice, (d) => d.name)
        .enter()
        .append('text')
        .attr('class', 'valueLabel')
        .attr('x', (d) => xScale(d.value) + 30)
        .attr('y', (d) => yScale(d.rank) + (yScale(1) - yScale(0)) / 2 + 8)
        .text((d) => d3.format(',.0f')(d.lastValue))

      // å¹´ä»½ç»˜åˆ¶
      svg
        .append('text')
        .attr('class', 'yearText')
        .attr('x', width - margin.right)
        .attr('y', height - 25)
        .attr('fill', '#2eb0c5d9')
        .attr('text-anchor', 'end')
        .attr('style', 'font-size:2em; font-weight: 500;font-weight: bold;')
        .html(~~year)
    }
  </script>
</html>
