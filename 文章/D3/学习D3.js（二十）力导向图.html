<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <style type="text/css"></style>
  <body>
    <div class="d3Chart"></div>
  </body>
  <!-- D3 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <script type="text/javascript">
    // èŠ‚ç‚¹é›†
    // radius èŠ‚ç‚¹åŠå¾„
    const nodes = [
      { name: 'é‡åº†å¸‚', radius: 4 },
      { name: 'åŒ—ç¢šåŒº', radius: 3 },
      { name: 'æ¸åŒ—åŒº', radius: 3 },
      { name: 'æ±ŸåŒ—åŒº', radius: 3 },
      { name: 'å·´å—åŒº', radius: 3 },
      { name: 'æ²™åªååŒº', radius: 3 },
      { name: 'å¤§æ¸¡å£', radius: 3 },
      { name: 'ä¸‡å·åŒº', radius: 3 },
      { name: 'å¤©åºœé•‡', radius: 2 },
      { name: 'æ°´åœŸé•‡', radius: 2 },
      { name: 'è”¡å®¶é•‡', radius: 2 },
      { name: 'åœŸåœºé•‡', radius: 2 },
      { name: 'ä¸¤æ±Ÿåå±…', radius: 1 },
      { name: 'ä¸ŠåŸä¸­å¤®', radius: 1 },
      { name: 'ç¯å¡”', radius: 1 }
    ]
    // è¾¹é›†
    // value æ§åˆ¶çº¿çš„é•¿çŸ­
    const edges = [
      { source: 0, target: 1, value: 2 },
      { source: 0, target: 2, value: 2 },
      { source: 0, target: 3, value: 2 },
      { source: 0, target: 4, value: 2 },
      { source: 0, target: 5, value: 2 },
      { source: 0, target: 6, value: 2 },
      { source: 0, target: 7, value: 2 },
      { source: 2, target: 8, value: 1.5 },
      { source: 2, target: 9, value: 1.5 },
      { source: 2, target: 10, value: 1.5 },
      { source: 2, target: 11, value: 1.5 },
      { source: 11, target: 12, value: 1 },
      { source: 11, target: 13, value: 1 },
      { source: 11, target: 14, value: 1 }
    ]

    // ç”»å¸ƒ
    const width = 1000
    const height = 1000
    const svg = d3
      .select('.d3Chart')
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .style('background-color', '#1a3055')
    // å›¾
    const chart = svg.append('g')

    // åˆ›å»ºé¢œè‰²æ¯”ä¾‹å°º
    const colorScale = d3.scaleOrdinal(d3.quantize(d3.interpolateRainbow, nodes.length + 1))

    // .forceSimulation() åˆ›å»ºä¸€ä¸ªåŠ›æ¨¡æ‹Ÿ
    // .force(name[, force]) å¦‚æœæŒ‡å®šäº†åŠ›ï¼Œåˆ™ä¸ºæŒ‡å®šçš„åç§°åˆ†é…åŠ›å¹¶è¿”å›æ­¤æ¨¡æ‹Ÿã€‚
    // d3.forceLink() é€‚ç”¨æ¯ä¸ªé“¾æ¥çš„æºå’Œç›®æ ‡ --é“¾æ¥åŠ›
    // d3.forceManyBody() -- å¤šä½“åŠ›
    // d3.forceCenter(x, y) ä½¿ç”¨æŒ‡å®šçš„xå’Œyåæ ‡åˆ›å»ºæ–°çš„å®šå¿ƒåŠ›ã€‚å¦‚æœæœªæŒ‡å®šxå’Œyï¼Œåˆ™é»˜è®¤ä¸ºâŸ¨0,0âŸ©ã€‚
    const force = d3
      .forceSimulation()
      .force('link', d3.forceLink())
      .force('charge', d3.forceManyBody())
      .force('center', d3.forceCenter(width / 2, height / 2))

    // .nodes() æŒ‡å®šèŠ‚ç‚¹ï¼Œå°†æ¨¡æ‹Ÿçš„èŠ‚ç‚¹è®¾ç½®ä¸ºæŒ‡å®šçš„å¯¹è±¡æ•°ç»„
    // .on('tick', fun) ç›‘å¬è¿­ä»£æ¬¡æ•°é€æ­¥æ‰§è¡Œæ¨¡æ‹Ÿ -- æ¯ä¸€æ¬¡åŠ›çš„æ¨¡æ‹Ÿéƒ½ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³•
    const forceNodes = force.nodes(nodes).on('tick', ticked)

    // .force('link') å¦‚æœæœªæŒ‡å®šåŠ›ï¼Œåˆ™è¿”å›å…·æœ‰æŒ‡å®šåç§°çš„force
    // .links() æŒ‡å®šé“¾æ¥ï¼Œè®¾ç½®ä¸æ­¤åŠ›å…³è”çš„é“¾æ¥æ•°ç»„ï¼Œé‡æ–°è®¡ç®—æ¯ä¸ªé“¾æ¥çš„è·ç¦»å’Œå¼ºåº¦å‚æ•°ï¼Œå¹¶è¿”å›æ­¤åŠ›
    // .distance() æŒ‡å®šè·ç¦»ï¼Œåˆ™å°†è·ç¦»è®¿é—®å™¨è®¾ç½®ä¸ºæŒ‡å®šçš„æ•°å­—æˆ–å‡½æ•°ï¼Œé‡æ–°è®¡ç®—æ¯ä¸ªé“¾æ¥çš„è·ç¦»è®¿é—®å™¨ï¼Œå¹¶è¿”å›æ­¤åŠ›
    force
      .force('link')
      .links(edges)
      .distance(function (d) {
        //æ¯ä¸€è¾¹çš„é•¿åº¦
        return d.value * 150
      })
    // åœ¨æµè§ˆå™¨çš„æ§åˆ¶å°è¾“å‡º
    console.log(nodes)
    console.log(edges)

    // åˆ›å»ºç»˜åˆ¶ç»„ ç»‘å®šæ•°æ®
    const line = chart.append('g').selectAll().data(edges).enter().append('g')
    // ç»˜åˆ¶çº¿
    const links = line.append('line').attr('stroke', '#ccc').attr('stroke-width', 1)
    const linksText = line
      .append('text')
      .text(function (d) {
        return d.value
      })
      .attr('fill', '#ccc')

    const nodesChart = chart
      .append('g')
      .selectAll()
      .data(nodes)
      .enter()
      .append('g')
      .attr('transform', function (d, i) {
        var cirX = d.x
        var cirY = d.y
        return 'translate(' + cirX + ',' + cirY + ')'
      })
      .call(d3.drag().on('start', started).on('drag', dragged).on('end', ended))

    nodesChart
      .append('circle')
      .attr('r', function (d, i) {
        // åŠå¾„
        return d.radius * 10
      })
      .attr('fill', function (d, i) {
        return colorScale(d.name)
      })

    nodesChart
      .append('text')
      .attr('x', -20)
      .attr('y', -5)
      .attr('dy', 10)
      .attr('font-size', 12)
      .text(function (d) {
        return d.name
      })
      .attr('fill', '#ccc')
      .attr('pointer-events', 'none')
      .style('user-select', 'none')

    function ticked() {
      links
        .attr('x1', function (d) {
          return d.source.x
        })
        .attr('y1', function (d) {
          return d.source.y
        })
        .attr('x2', function (d) {
          return d.target.x
        })
        .attr('y2', function (d) {
          return d.target.y
        })

      linksText
        .attr('x', function (d) {
          return (d.source.x + d.target.x) / 2
        })
        .attr('y', function (d) {
          return (d.source.y + d.target.y) / 2
        })

      nodesChart.attr('transform', function (d) {
        return 'translate(' + d.x + ',' + d.y + ')'
      })
    }

    console.log('ğŸš€ ~ file: å­¦ä¹ D3.jsï¼ˆäºŒåï¼‰åŠ›å¯¼å‘å›¾.html ~ line 175 ~ d3.event.active ', d3.event)

    // d.fx å’Œ d.fy è¡¨ç¤ºå›ºå®šåæ ‡
    function started(e, d) {
      force.alphaTarget(0.8).restart() // è®¾ç½®è¡°å‡ç³»æ•°ï¼Œå¯¹èŠ‚ç‚¹ä½ç½®ç§»åŠ¨è¿‡ç¨‹çš„æ¨¡æ‹Ÿï¼Œæ•°å€¼è¶Šé«˜ç§»åŠ¨è¶Šå¿«ï¼Œæ•°å€¼èŒƒå›´[0ï¼Œ1]
      d.fx = d.x
      d.fy = d.y
    }
    function dragged(e, d) {
      d.fx = e.x
      d.fy = e.y
    }
    function ended(e, d) {
      force.alphaTarget(0)
      d.fx = null
      d.fy = null
    }
  </script>
</html>
